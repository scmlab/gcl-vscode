// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Vscode = require("vscode");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var View$Guacamole = require("./View.bs.js");
var State$Guacamole = require("./State.bs.js");
var Command$Guacamole = require("./Command.bs.js");

var dict = { };

function get(editor) {
  return Js_dict.get(dict, editor.document.fileName);
}

function getByFileName(fileName) {
  return Js_dict.get(dict, fileName);
}

function set(fileName, state) {
  console.log("[ states ][ set ]", fileName);
  dict[fileName] = state;
  return /* () */0;
}

function isLoaded(editor) {
  return Belt_Option.isSome(Js_dict.get(dict, editor.document.fileName));
}

function disposeByFileName(fileName) {
  console.log("[ states ][ delete ]", fileName);
  Belt_Option.forEach(Js_dict.get(dict, fileName), State$Guacamole.dispose);
  ((delete dict[fileName]));
  return /* () */0;
}

function disposeAll(param) {
  return Belt_Array.map(Js_dict.entries(dict), (function (param) {
                return State$Guacamole.dispose(param[1]);
              }));
}

var States = {
  dict: dict,
  get: get,
  getByFileName: getByFileName,
  set: set,
  isLoaded: isLoaded,
  disposeByFileName: disposeByFileName,
  disposeAll: disposeAll
};

var partial_arg = /\.gcl$/i;

function isGCL(param) {
  return partial_arg.test(param);
}

function getActiveGCLEditor(param) {
  return Belt_Option.flatMap(Vscode.window.activeTextEditor, (function (editor) {
                if (isGCL(editor.document.fileName)) {
                  return Caml_option.some(editor);
                }
                
              }));
}

function getOrMakeState(context) {
  return Belt_Option.map(getActiveGCLEditor(/* () */0), (function (editor) {
                var match = get(editor);
                if (match !== undefined) {
                  return match;
                } else {
                  var state = State$Guacamole.make(context, editor, editor);
                  set(editor.document.fileName, state);
                  return state;
                }
              }));
}

function get$1(param) {
  return Belt_Option.flatMap(getActiveGCLEditor(/* () */0), get);
}

function addToSubscriptions(f, context) {
  context.subscriptions.push(f);
  return /* () */0;
}

function activate(context) {
  addToSubscriptions(Vscode.workspace.onDidRenameFiles((function ($$event) {
              return Belt_Option.forEach(Belt_Option.map($$event, (function (prim) {
                                return prim.files;
                              })), (function (files) {
                            return Belt_Array.forEach(Belt_Array.keep(Belt_Array.keep(files, (function (file) {
                                                  return isGCL(file.oldUri.path);
                                                })), (function (file) {
                                              return !isGCL(file.newUri.path);
                                            })), (function (file) {
                                          return disposeByFileName(file.oldUri.path);
                                        }));
                          }));
            })), context);
  addToSubscriptions(Vscode.workspace.onDidCloseTextDocument((function (textDoc) {
              return Belt_Option.forEach(Belt_Option.flatMap(Belt_Option.map(textDoc, (function (prim) {
                                    return prim.fileName;
                                  })), getByFileName), State$Guacamole.dispose);
            })), context);
  addToSubscriptions(Vscode.window.onDidChangeActiveTextEditor((function (editor) {
              return Belt_Option.forEach(Belt_Option.flatMap(editor, get), View$Guacamole.activate);
            })), context);
  addToSubscriptions(Vscode.commands.registerCommand("extension.load", (function (param) {
              return Belt_Option.forEach(getOrMakeState(context), Command$Guacamole.load);
            })), context);
  return addToSubscriptions(Vscode.commands.registerCommand("workbench.action.files.save", (function (param) {
                    return Belt_Option.forEach(Belt_Option.flatMap(getActiveGCLEditor(/* () */0), get), (function (state) {
                                  console.log(state.editor.document.fileName);
                                  return /* () */0;
                                }));
                  })), context);
}

function deactive(param) {
  return disposeAll(/* () */0);
}

exports.States = States;
exports.isGCL = isGCL;
exports.getActiveGCLEditor = getActiveGCLEditor;
exports.getOrMakeState = getOrMakeState;
exports.get = get$1;
exports.addToSubscriptions = addToSubscriptions;
exports.activate = activate;
exports.deactive = deactive;
/* vscode Not a pure module */
