// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Path = require("path");
var Curry = require("bs-platform/lib/js/curry.js");
var VSCode = require("bs-vscode/lib/js/src/VSCode.bs.js");
var Vscode = require("vscode");
var Js_math = require("bs-platform/lib/js/js_math.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Chan$Guacamole = require("./Util/Chan.bs.js");
var Caml_js_exceptions = require("bs-platform/lib/js/caml_js_exceptions.js");
var ViewType$Guacamole = require("./View/ViewType.bs.js");

function makeHTML(webview, extensionPath) {
  var extensionUri = Vscode.Uri.file(extensionPath);
  var text = "";
  var charaterSet = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
  var cardinality = charaterSet.length;
  for(var _for = 0; _for <= 32; ++_for){
    text = text + charaterSet.charAt(Js_math.floor(Math.random() * cardinality));
  }
  var nonce = text;
  var scriptUri = webview.asWebviewUri(Vscode.Uri.joinPath(extensionUri, "dist", "bundled-view.js")).toString();
  var cspSourceUri = webview.cspSource;
  var styleUri = webview.asWebviewUri(Vscode.Uri.joinPath(extensionUri, "dist", "style.css")).toString();
  var codiconsUri = webview.asWebviewUri(Vscode.Uri.joinPath(extensionUri, "dist", "codicon.css")).toString();
  var codiconsFontUri = webview.asWebviewUri(Vscode.Uri.joinPath(extensionUri, "dist", "codicon.ttf")).toString();
  var scriptSrc = "script-src 'nonce-" + nonce + "'; ";
  var styleSrc = "style-src " + cspSourceUri + " " + styleUri + " " + codiconsUri + "; ";
  var fontSrc = "font-src " + codiconsFontUri + "; ";
  var scp = "default-src 'none'; " + fontSrc + scriptSrc + styleSrc;
  return "\n      <!DOCTYPE html>\n      <html lang=\"en\">\n      <head>\n        <meta charset=\"utf-8\">\n        <meta name=\"viewport\" content=\"width=device-width,initial-scale=1,shrink-to-fit=no\">\n        <meta name=\"theme-color\" content=\"#000000\">\n\n        <!--\n					Use a content security policy to only allow loading images from https or from our extension directory,\n					and only allow scripts that have a specific nonce.\n				-->\n        <meta http-equiv=\"Content-Security-Policy\" content=\"" + scp + "\">\n\n        <title>React App</title>\n        <link href=\"" + styleUri + "\"    rel=\"stylesheet\" type=\"text/css\" >\n        <link href=\"" + codiconsUri + "\" rel=\"stylesheet\" />\n      </head>\n      <body>\n        <noscript>You need to enable JavaScript to run this app.</noscript>\n        <div id=\"root\"></div>\n        <script nonce=\"" + nonce + "\" src=\"" + scriptUri + "\"></script>\n      </body>\n      </html>\n    ";
}

function make(extensionPath) {
  var distPath = Path.join(extensionPath, "dist");
  var panel = Vscode.window.createWebviewPanel("panel", "Guacamole", {
        preserveFocus: true,
        viewColumn: 3
      }, VSCode.WebviewAndWebviewPanelOptions.make(undefined, true, [Vscode.Uri.file(distPath)], undefined, undefined, true, undefined));
  var html = makeHTML(panel.webview, extensionPath);
  panel.webview.html = html;
  return panel;
}

var Panel = {
  makeHTML: makeHTML,
  make: make
};

function send(view, req) {
  var queued = view.status;
  if (queued) {
    queued._0.push(req);
    return $$Promise.resolved(false);
  }
  var stringified = JSON.stringify(ViewType$Guacamole.$$Request.encode(req));
  return view.panel.webview.postMessage(stringified);
}

function make$1(extensionPath) {
  var view = {
    panel: make(extensionPath),
    onResponse: Chan$Guacamole.make(undefined),
    subscriptions: [],
    status: {
      _0: [],
      [Symbol.for("name")]: "Uninitialized"
    }
  };
  view.subscriptions.push(view.panel.webview.onDidReceiveMessage(function (json) {
            var result;
            try {
              result = Curry._1(ViewType$Guacamole.$$Response.decode, json);
            }
            catch (raw_e){
              var e = Caml_js_exceptions.internalToOCamlException(raw_e);
              console.log("[ panic ][ Webview.onDidReceiveMessage JSON decode error ]", e);
              return ;
            }
            return Chan$Guacamole.emit(view.onResponse, result);
          }));
  view.subscriptions.push(view.panel.onDidDispose(function (param) {
            return Chan$Guacamole.emit(view.onResponse, /* Destroyed */3);
          }));
  view.subscriptions.push(new Vscode.Disposable(Chan$Guacamole.on(view.onResponse, (function (x) {
                  if (typeof x !== "number") {
                    return ;
                  }
                  if (x !== 2) {
                    return ;
                  }
                  var queued = view.status;
                  if (queued) {
                    view.status = /* Initialized */0;
                    return Belt_Array.forEach(queued._0, (function (req) {
                                  send(view, req);
                                  
                                }));
                  }
                  
                }))));
  return view;
}

function destroy(view) {
  view.panel.dispose();
  return Chan$Guacamole.destroy(view.onResponse);
}

function onceDestroyed(view) {
  var match = $$Promise.pending(undefined);
  var resolve = match[1];
  var disposable = Chan$Guacamole.on(view.onResponse, (function (response) {
          if (typeof response === "number" && response >= 3) {
            return Curry._1(resolve, undefined);
          }
          
        }));
  return $$Promise.tap(match[0], disposable);
}

var View = {
  send: send,
  make: make$1,
  destroy: destroy,
  onceDestroyed: onceDestroyed
};

var handle = {
  view: undefined
};

function send$1(req) {
  var view = handle.view;
  if (view !== undefined) {
    return send(view, req);
  } else {
    return $$Promise.resolved(false);
  }
}

function on(callback) {
  var view = handle.view;
  if (view !== undefined) {
    return new Vscode.Disposable(Chan$Guacamole.on(view.onResponse, callback));
  } else {
    return new Vscode.Disposable((function (param) {
                  
                }));
  }
}

function activate(extensionPath, devMode) {
  var view = make$1(extensionPath);
  handle.view = view;
  $$Promise.get(onceDestroyed(view), (function (param) {
          handle.view = undefined;
          
        }));
  return send$1({
              TAG: 0,
              _0: devMode,
              [Symbol.for("name")]: "UpdateDevMode"
            });
}

function deactivate(param) {
  Belt_Option.forEach(handle.view, destroy);
  handle.view = undefined;
  
}

function isActivated(param) {
  return Belt_Option.isSome(handle.view);
}

function focus(param) {
  return Belt_Option.forEach(handle.view, (function (view) {
                return VSCode.WebviewPanel.reveal(view.panel, undefined, undefined, undefined);
              }));
}

var Controller = {
  activate: activate,
  deactivate: deactivate,
  isActivated: isActivated,
  send: send$1,
  on: on,
  focus: focus
};

exports.Panel = Panel;
exports.View = View;
exports.Controller = Controller;
exports.activate = activate;
exports.deactivate = deactivate;
exports.isActivated = isActivated;
exports.send = send$1;
exports.on = on;
exports.focus = focus;
/* path Not a pure module */
