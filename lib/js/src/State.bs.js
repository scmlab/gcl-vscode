// Generated by ReScript, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var VSCode = require("bs-vscode/lib/js/src/VSCode.bs.js");
var Vscode = require("vscode");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var $$Promise = require("reason-promise/lib/js/src/js/promise.bs.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Belt_Option = require("bs-platform/lib/js/belt_Option.js");
var Caml_option = require("bs-platform/lib/js/caml_option.js");
var GCL$Guacamole = require("./GCL.bs.js");
var Util$Guacamole = require("./Util/Util.bs.js");
var Editor$Guacamole = require("./Util/Editor.bs.js");

function subscribe(disposable, state) {
  state.subscriptions.push(disposable);
  
}

function display(state, id, pos, props) {
  return $$Promise.map(Curry._1(state.viewSendRequest, {
                  TAG: 1,
                  _0: id,
                  _1: pos,
                  _2: props,
                  [Symbol.for("name")]: "Display"
                }), (function (param) {
                
              }));
}

function focus(state) {
  Vscode.window.showTextDocument(state.document, /* Beside */1, undefined);
  
}

var HandleError = {};

function fromCursorPosition(state) {
  var cursor = state.editor.selection.end;
  var smallestHole = {
    contents: undefined
  };
  Belt_Array.forEach(Belt_Array.keep(state.specifications, (function (spec) {
              var range = GCL$Guacamole.Loc.toRange(spec.loc);
              return range.contains(cursor);
            })), (function (spec) {
          var spec$prime = smallestHole.contents;
          if (spec$prime !== undefined && !GCL$Guacamole.Loc.toRange(spec.loc).contains(GCL$Guacamole.Loc.toRange(spec$prime.loc))) {
            return ;
          } else {
            smallestHole.contents = spec;
            return ;
          }
        }));
  return smallestHole.contents;
}

function getPayloadRange(doc, spec) {
  var range = GCL$Guacamole.Loc.toRange(spec.loc);
  var startingLine = range.start.line + 1 | 0;
  var endingLine = range.end.line - 1 | 0;
  var start = doc.lineAt(startingLine).range.start;
  var end_ = doc.lineAt(endingLine).range.end;
  return new Vscode.Range(start, end_);
}

function getPayload(doc, spec) {
  var innerRange = getPayloadRange(doc, spec);
  return doc.getText(Caml_option.some(innerRange));
}

function resolve(state, i) {
  var specs = Belt_Array.keep(state.specifications, (function (spec) {
          return spec.id === i;
        }));
  Belt_Option.forEach(Belt_Array.get(specs, 0), (function (spec) {
          var payload = getPayload(state.document, spec);
          var range = GCL$Guacamole.Loc.toRange(spec.loc);
          var start = range.start;
          return $$Promise.get($$Promise.flatMap(Editor$Guacamole.$$Text.$$delete(state.document, range), (function (result) {
                            if (result) {
                              return Editor$Guacamole.$$Text.insert(state.document, start, payload.trim());
                            } else {
                              return $$Promise.resolved(false);
                            }
                          })), (function (param) {
                        
                      }));
        }));
  return $$Promise.resolved(undefined);
}

function insert(state, lineNo, expr) {
  var assertion = "{ " + Curry._1(GCL$Guacamole.Syntax.Expr.toString, expr) + " }\n";
  var point = new Vscode.Position(lineNo - 1 | 0, 0);
  return Editor$Guacamole.$$Text.insert(state.document, point, assertion);
}

var Spec = {
  fromCursorPosition: fromCursorPosition,
  getPayloadRange: getPayloadRange,
  getPayload: getPayload,
  resolve: resolve,
  insert: insert
};

function handleResponseKind(state, kind) {
  switch (kind.TAG | 0) {
    case /* Error */0 :
        return $$Promise.resolved(undefined);
    case /* OK */1 :
        state.specifications = kind._2;
        return display(state, kind._0, kind._1, kind._3);
    case /* Resolve */2 :
        return $$Promise.map($$Promise.flatMap(resolve(state, kind._0), (function (param) {
                          return state.document.save();
                        })), (function (param) {
                      
                    }));
    case /* Substitute */3 :
        return $$Promise.map(Curry._1(state.viewSendRequest, {
                        TAG: 0,
                        _0: kind._0,
                        _1: kind._1,
                        [Symbol.for("name")]: "Substitute"
                      }), (function (param) {
                      
                    }));
    
  }
}

function handleResponseWithState(state, response) {
  switch (response.TAG | 0) {
    case /* Res */0 :
        return $$Promise.map(Util$Guacamole.$$Promise.oneByOne(Belt_Array.map(response._1, (function (param) {
                              return handleResponseKind(state, param);
                            }))), (function (param) {
                      
                    }));
    case /* CannotDecodeResponse */1 :
        console.error("Client Internal Error\nCannot decode response from the server\n" + response._0, response._1);
        return $$Promise.resolved(undefined);
    case /* CannotDecodeRequest */2 :
        console.error("Server Internal Error\nCannot decode request from the client\n" + response._0);
        return $$Promise.resolved(undefined);
    case /* CannotSendRequest */3 :
        console.error("Client Internal Error\nCannot send request to the server\n" + response._0);
        return $$Promise.resolved(undefined);
    
  }
}

var dict = {};

var $$delete = (function (dict, id) {delete dict[id]});

function addBackground(state, key, range, color) {
  var backgroundColor = VSCode.StringOr.others(new Vscode.ThemeColor(color));
  var options = {
    backgroundColor: backgroundColor
  };
  var decoration = Vscode.window.createTextEditorDecorationType(options);
  state.editor.setDecorations(decoration, [range]);
  dict[key] = [decoration];
  
}

function remove(key) {
  Belt_Option.forEach(Js_dict.get(dict, key), (function (decos) {
          return Belt_Array.forEach(decos, (function (prim) {
                        prim.dispose();
                        
                      }));
        }));
  return $$delete(dict, key);
}

function removeAll(param) {
  return Belt_Array.forEach(Js_dict.entries(dict), (function (param) {
                $$delete(dict, param[0]);
                return Belt_Array.forEach(param[1], (function (prim) {
                              prim.dispose();
                              
                            }));
              }));
}

var Decoration = {
  addBackground: addBackground,
  remove: remove,
  removeAll: removeAll
};

function make(editor, viewSendRequest, viewOnResponse, lspSendRequest) {
  var $$document = editor.document;
  var filePath = $$document.fileName;
  var state = {
    editor: editor,
    document: $$document,
    filePath: filePath,
    viewSendRequest: viewSendRequest,
    viewOnResponse: viewOnResponse,
    lspSendRequest: lspSendRequest,
    specifications: [],
    subscriptions: []
  };
  state.subscriptions.push(new Vscode.Disposable(Curry._1(viewOnResponse, (function (response) {
                  if (typeof response === "number") {
                    return ;
                  }
                  if (response.TAG) {
                    removeAll(undefined);
                    $$Promise.flatMap(Curry._1(lspSendRequest, {
                              _0: state.filePath,
                              _1: {
                                TAG: 2,
                                _0: response._0,
                                _1: response._1,
                                _2: response._2,
                                [Symbol.for("name")]: "Substitute"
                              },
                              [Symbol.for("name")]: "Req"
                            }), (function (param) {
                            return handleResponseWithState(state, param);
                          }));
                    return ;
                  }
                  var loc = response._0;
                  switch (loc.TAG | 0) {
                    case /* MouseOver */0 :
                        var loc$1 = loc._0;
                        var key = GCL$Guacamole.Loc.toString(loc$1);
                        var range = GCL$Guacamole.Loc.toRange(loc$1);
                        return addBackground(state, key, range, "statusBar.debuggingBackground");
                    case /* MouseOut */1 :
                        return remove(GCL$Guacamole.Loc.toString(loc._0));
                    case /* MouseClick */2 :
                        return ;
                    
                  }
                }))));
  return state;
}

function destroy(state) {
  Belt_Array.forEach(state.subscriptions, (function (prim) {
          return prim.dispose();
        }));
  state.subscriptions = [];
  
}

exports.subscribe = subscribe;
exports.display = display;
exports.focus = focus;
exports.HandleError = HandleError;
exports.Spec = Spec;
exports.handleResponseKind = handleResponseKind;
exports.handleResponseWithState = handleResponseWithState;
exports.Decoration = Decoration;
exports.make = make;
exports.destroy = destroy;
/* VSCode Not a pure module */
