// Generated by BUCKLESCRIPT, PLEASE EDIT WITH CARE
'use strict';

var Curry = require("bs-platform/lib/js/curry.js");
var React = require("react");
var Js_dict = require("bs-platform/lib/js/js_dict.js");
var Caml_obj = require("bs-platform/lib/js/caml_obj.js");
var Belt_Array = require("bs-platform/lib/js/belt_Array.js");
var Util$Guacamole = require("../Util/Util.bs.js");
var Event$Guacamole = require("../Util/Event.bs.js");
var ReqID$Guacamole = require("./ReqID.bs.js");
var Common$Guacamole = require("./Common.bs.js");
var Caml_chrome_debugger = require("bs-platform/lib/js/caml_chrome_debugger.js");

var emitter = Event$Guacamole.make(undefined);

var eventContext = React.createContext(emitter);

function makeProps(value, children, param) {
  return {
          value: value,
          children: children
        };
}

var make = eventContext.Provider;

var Provider = {
  makeProps: makeProps,
  make: make
};

var counter = {
  contents: 0
};

function Subst(Props) {
  var expr = Props.expr;
  var subst = Props.subst;
  var makeExpr = Props.makeExpr;
  var makeExprProps = Props.makeExprProps;
  var emitter = React.useContext(eventContext);
  var match = React.useState((function () {
          return false;
        }));
  var setHover = match[1];
  var match$1 = React.useState((function () {
          return /* Unreduced */Caml_chrome_debugger.variant("Unreduced", 0, [
                    expr,
                    subst
                  ]);
        }));
  var setRedux = match$1[1];
  var redux = match$1[0];
  var id = React.useRef(undefined);
  var reqID = React.useRef(undefined);
  var onMouseOver = function (param) {
    return Curry._1(setHover, (function (param) {
                  return true;
                }));
  };
  var onMouseLeave = function (param) {
    return Curry._1(setHover, (function (param) {
                  return false;
                }));
  };
  var onClick = function (param) {
    Curry._1(emitter.emit, /* Request */Caml_chrome_debugger.variant("Request", 0, [
            counter.contents,
            expr,
            subst
          ]));
    id.current = counter.contents;
    counter.contents = counter.contents + 1 | 0;
    
  };
  var tmp;
  tmp = typeof redux === "number" || !redux.tag ? "" : " reduced";
  var className = "expr-subst" + ((
      match[0] ? " hovered" : ""
    ) + tmp);
  reqID.current = React.useContext(ReqID$Guacamole.context);
  if (typeof redux !== "number" && redux.tag) {
    if (Caml_obj.caml_notequal(redux[0], reqID.current)) {
      console.log("invalidate!! ");
      Curry._1(setRedux, (function (param) {
              return /* Unreduced */Caml_chrome_debugger.variant("Unreduced", 0, [
                        expr,
                        subst
                      ]);
            }));
    }
    
  }
  React.useEffect((function () {
          return Curry._1(emitter.on, (function (param) {
                        if (!param.tag) {
                          return ;
                        }
                        if (!Caml_obj.caml_equal(param[0], id.current)) {
                          return ;
                        }
                        var expr = param[1];
                        return Curry._1(setRedux, (function (param) {
                                      return /* Reduced */Caml_chrome_debugger.variant("Reduced", 1, [
                                                reqID.current,
                                                expr
                                              ]);
                                    }));
                      }));
        }), []);
  if (typeof redux === "number") {
    return React.createElement(React.Fragment, undefined, "...");
  }
  if (redux.tag) {
    return React.createElement(makeExpr, Curry._3(makeExprProps, 0, redux[1], undefined));
  }
  var e = Belt_Array.map(Js_dict.entries(redux[1]), (function (param) {
          return React.createElement(React.Fragment, undefined, React.createElement(makeExpr, Curry._3(makeExprProps, 0, param[1], undefined)), "/" + param[0]);
        }));
  return React.createElement(React.Fragment, undefined, React.createElement(makeExpr, Curry._3(makeExprProps, 0, redux[0], undefined)), React.createElement(Common$Guacamole.Space.make, { }), React.createElement("div", {
                  className: className,
                  onClick: onClick,
                  onMouseLeave: onMouseLeave,
                  onMouseOver: onMouseOver
                }, "[", Util$Guacamole.React.sepBy(", ", e), "]"));
}

var make$1 = Subst;

exports.emitter = emitter;
exports.eventContext = eventContext;
exports.Provider = Provider;
exports.counter = counter;
exports.make = make$1;
/* emitter Not a pure module */
